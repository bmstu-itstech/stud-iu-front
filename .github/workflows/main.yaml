name: Test stud_iu_front
on: [push, workflow_dispatch, pull_request]

jobs:
  install-cache:
    name: Install & Cache
    runs-on: ubuntu-latest
    steps:
      - name: Get the repository code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache node modules
        uses: actions/cache@v4
        id: cache-node-modules
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}-v1

  lint-check:
    name: Run Linters
    runs-on: ubuntu-latest
    needs: [ 'install-cache' ]
    steps:
      - name: Get the repository code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Restore node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}-v1

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run Lint
        run: npm run lint

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: ['lint-check']
    steps:
      - name: Get the repository code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Restore node modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}-v1

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run build
        run: npm run build

  telegram-notify:
    name: Telegram Notification
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    steps:
      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: html
          message: |
            <b>${{ needs.build.result == 'success' && 'âœ… Build Success' || 'âŒ Build Failed' }}</b>
            
            <b>ğŸ“¦ Repo:</b> <a href="https://github.com/${{ github.repository }}">${{ github.repository }}</a>
            <b>ğŸŒ¿ Branch:</b> ${{ github.ref_name }}
            <b>ğŸ‘¤ User:</b> ${{ github.actor }}
            
            <b>ğŸ’¬ Commit:</b>
            <code>${{ github.event.head_commit.message }}</code>
            
            ğŸ”— <a href="https://github.com/${{ github.repository }}/commit/${{ github.sha }}">View Changes</a>
            ğŸ¬ <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Action</a>
