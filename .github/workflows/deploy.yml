name: Deploy to Production
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via Git Clone
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
            if command -v pm2 &> /dev/null; then
              echo "Stopping PM2 process..."
              pm2 stop stud-iu || echo "PM2 process 'stud-iu' not running"
              pm2 delete stud-iu || echo "PM2 process 'stud-iu' not found"
            fi

            # –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –ø–∞–ø–∫—É –∏ —Å–æ–∑–¥–∞–µ–º –∑–∞–Ω–æ–≤–æ
            sudo rm -rf ~/stud-iu/stud-iu-front
            sudo mkdir -p ~/stud-iu/stud-iu-front
            sudo chown -R tech:tech /home/tech/stud-iu/stud-iu-front

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –∏ –∫–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            cd /home/tech/stud-iu/stud-iu-front
            git clone -b main https://github.com/bmstu-itstech/stud-iu-front.git .

            # –°–æ–∑–¥–∞–Ω–∏–µ env —Ñ–∞–π–ª–∞
            echo "Creating .env file..."
            touch .env
            echo NEXT_PUBLIC_API_URL=http://${{ secrets.SERVER_HOST || 'localhost' }}:8000/api/v0 >> .env

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "Installing dependencies..."
            npm ci

            # –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
            echo "Building project..."
            npm run build

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if ! command -v pm2 &> /dev/null; then
              sudo npm install -g pm2
            fi

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º production –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "Installing production dependencies..."
            npm ci --production

            # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            echo "Starting application..."
            pm2 start npm --name "stud-iu" -- start
            pm2 save
            pm2 list

  notify_success:
    name: Success Message
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Send Telegram Success Message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã

            üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–æ–¥ üîó
            ${{ secrets.SERVER_HOST || '–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç' }}

  notify_failure:
    name: Failure Message
    if: ${{ needs.deploy.result == 'failure' }}
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram Failure Message
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ‚ùóÔ∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –¥–µ–ø–ª–æ—è

            üîó –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–∞–π–ø–ª–∞–π–Ω üîó
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}